#!/usr/bin/env bash

case $(uname) in
  Darwin) script_dir=$(cd $(dirname "${0}") ; pwd -P) ;;
  Linux)  script_dir=$(realpath $(dirname "${0}")) ;;
  *)      echo "Fuck off, platform $(uname) is not supported!" ;;
esac

target_name=${1}
target_pip=$(terraform state show ibm_is_instance.${target_name} | awk -F '"' '/primary_ipv4_address/{print $2}')
bastion_key_file=$(cat ${script_dir}/../main.auto.tfvars  | awk -F '"' '/bastion_key/{print $2}')
bastion_fip=$(terraform state show -state ${script_dir}/../terraform.tfstate module.vpc.ibm_is_floating_ip.bastion_server_fip[0] | awk '/address/{print $3}' | awk -F '"' '{print $2}')
cluster_key_file=$(cat ${script_dir}/../main.auto.tfvars  | awk -F '"' '/cluster_key/{print $2}')

exec ssh \
  -o ProxyCommand='ssh -W %h:%p -i '${bastion_key_file}' root@'${bastion_fip} \
  -i ${cluster_key_file} root@${target_pip}
